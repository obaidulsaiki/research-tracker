<div class="app-shell animate-fade-in">
    <app-dashboard-sidebar [activeTab]="activeTab()" (tabChange)="onTabChange($event)"
        (onViewPortfolio)="viewPortfolio()">
    </app-dashboard-sidebar>

    <main class="app-main">
        <app-dashboard-header [activeTab]="activeTab()" (search)="searchTerm.set($event); currentPage.set(1)"
            (onExport)="exportData()" (onAddResearch)="openAddModal()" (excelSelected)="onExcelSelected($event)"
            (fileSelected)="onFileSelected($event)">
        </app-dashboard-header>

        <div class="app-content">
            @if (activeTab() === 'overview') {
            <app-overview-tab [stats]="mainStats()" [history]="recentHistory()" [activityData]="activityData()"
                [settings]="sysSettings()" (viewAllHistory)="activeTab.set('history')"
                (statClick)="onStatFilterChange($event)"
                (onUpdateSettings)="settingsService.updateSettings($event).subscribe()">
            </app-overview-tab>
            }

            @if (activeTab() === 'archive' || activeTab() === 'running' || activeTab() === 'hypothesis') {
            <app-archive-tab [papers]="paginatedPapers()" [totalPapersCount]="researchItems().length"
                [totalFilteredCount]="filteredPapers().length" [currentPage]="currentPage()" [pageSize]="pageSize()"
                [totalPages]="totalPages()" [pages]="pages()" [filterStatus]="filterStatus()"
                [filterType]="filterType()" [filterYear]="filterYear()" [filterPublisher]="filterPublisher()"
                [filterQuartile]="filterQuartile()" [availableTypes]="availableTypes" [availableYears]="availableYears"
                [availablePublishers]="availablePublishers" [groupedPublishers]="groupedPublishers"
                (filterChange)="onTabFilterChange($event)" (onPageChange)="currentPage.set($event)"
                (onEdit)="openEditModal($event)" (onDelete)="deleteItem($event)" (onSyncPublic)="syncPublicProfile()"
                (onClearFilters)="clearFilters()" (onClearDatabase)="showBulkConfirm.set(true)">
            </app-archive-tab>
            }

            @if (activeTab() === 'analytics') {
            <app-analytics-tab [totalCount]="researchItems().length" [typeDist]="typeDistribution()"
                [positionDist]="positionDistribution()" [statusDist]="statusDistribution()"
                [quartileDist]="quartileDistribution()">
            </app-analytics-tab>
            }

            @if (activeTab() === 'history') {
            <app-history-tab [groupedHistory]="groupedHistory()" [totalEvents]="history().length"
                [researchItems]="researchItems()">
            </app-history-tab>
            }

            @if (activeTab() === 'authors') {
            <app-authors-tab [coAuthors]="coAuthorStats()" (viewAuthor)="viewAuthor($event)"></app-authors-tab>
            }

            @if (activeTab() === 'author-detail') {
            <app-author-detail [authorName]="selectedAuthor() || ''" [allPapers]="researchItems()"
                (back)="backToAuthors()" (filterReset)="showSuccess('Filters reset to show all papers')">
            </app-author-detail>
            }

            @if (activeTab() === 'download') {
            <app-download-tab [itemCount]="researchItems().length" (onExcel)="exportToExcel()" (onPdf)="exportToPdf()"
                (onCsv)="exportData()">
            </app-download-tab>
            }
        </div>
    </main>

    @if (successNotification()) {
    <div class="success-toast">
        <div class="toast-content">
            <span class="toast-icon">✨</span>
            <div class="toast-text-group">
                <span class="toast-title">Update Successful</span>
                <span class="toast-msg">{{ successNotification() }}</span>
            </div>
        </div>
    </div>
    }

    @if (errorNotification()) {
    <div class="error-toast">
        <div class="toast-content">
            <span class="toast-icon">⚠️</span>
            <div class="toast-text-group">
                <span class="toast-title">Sync Error</span>
                <span class="toast-msg">{{ errorNotification() }}</span>
            </div>
        </div>
    </div>
    }

    @if (showModal()) {
    <app-add-paper-modal [editData]="itemToEdit()" (close)="closeModal($event)"></app-add-paper-modal>
    }
    @if (confirmDeleteId() !== null) {
    <app-confirm-modal (cancel)="confirmDeleteId.set(null)" (confirm)="handleDelete()"></app-confirm-modal>
    }
    @if (showBulkConfirm()) {
    <app-confirm-modal title="DANGER: Delete All Records?"
        message="This will permanently wipe EVERYTHING from the database: all papers, all authors, and all history logs. This CANNOT be undone."
        confirmText="Yes, WIPE EVERYTHING" (cancel)="showBulkConfirm.set(false)" (confirm)="handleBulkDelete()">
    </app-confirm-modal>
    }
</div>